<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product List ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Code 6</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Prompt', 'sans-serif'] } } }
        }
    </script>

    <style>
        body {
            background-color: #f1f5f9;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Style Fallbacks for Intermittent CDN issues */
        img {
            max-width: 100%;
            height: auto;
        }

        #connectionScreen img {
            width: 64px !important;
        }

        aside img {
            width: 40px !important;
        }

        /* The original #connectionScreen img rule was here, but it's now modified above. */

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            .sidebar-open aside {
                transform: translateX(0);
            }

            aside {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 70;
                /* Higher than connection screen if needed */
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }

            .mobile-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(2px);
                z-index: 60;
            }

            .sidebar-open .mobile-overlay {
                display: block;
            }

            /* Responsive Grid Fallbacks if Tailwind is slow */
            .grid-cols-responsive {
                grid-template-columns: 1fr !important;
            }

            @media (min-width: 640px) {
                .grid-cols-responsive {
                    grid-template-columns: repeat(2, 1fr) !important;
                }
            }
        }
    </style>
</head>

<body class="text-slate-800 dark:text-slate-200 h-screen flex overflow-hidden font-sans dark:bg-slate-900">

    <!-- CONNECTION SCREEN (Replaces LOGIN) -->
    <div id="connectionScreen"
        class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-emerald-900 p-4">
        <div class="glass dark:bg-slate-800/80 w-full max-w-md p-8 rounded-2xl shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-teal-400"></div>
            <div class="text-center mb-8">
                <img src="assets/logo.png" alt="SFC Logo"
                    class="w-16 h-16 object-contain rounded-2xl mx-auto mb-4 drop-shadow-md">
                <h1 class="text-2xl font-bold text-slate-800 dark:text-white">Product List ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Code 6</h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cloud)</p>
            </div>

            <!-- Google Sheets Loader -->
            <div class="space-y-4">
                <div class="relative group">
                    <input type="text" id="sheetUrlInput"
                        class="w-full bg-white dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 px-4 py-4 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition font-mono text-xs"
                        placeholder="‡∏ß‡∏≤‡∏á Google Script Web App URL ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
                </div>

                <button onclick="connectToSheet()" id="connectBtn"
                    class="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-600/20 hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                    <i class="fas fa-link"></i> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cloud
                </button>

                <!-- Reconnect Area inside Loader -->
                <div id="reconnectArea" class="hidden animate-pulse">
                    <button onclick="reconnectLastSheet()"
                        class="w-full py-3 bg-slate-700 text-white rounded-lg font-bold hover:bg-slate-600 transition flex items-center justify-center gap-2">
                        <i class="fas fa-history"></i> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </button>
                    <div id="lastFileHint" class="text-center text-[10px] text-emerald-500 mt-2 font-medium"></div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 text-center">
                <p class="text-xs text-slate-400">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>
        </div>
        <div class="absolute bottom-4 text-slate-500 text-xs opacity-50">SFC Product List Management System &copy; 2025
        </div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div id="app" class="hidden flex w-full h-full">
        <!-- Mobile Overlay -->
        <div id="mobileOverlay" class="mobile-overlay" onclick="toggleSidebar(false)"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-[60]">
            <div class="p-6 border-b border-slate-800 bg-slate-900/50 flex items-center gap-3">
                <img src="assets/logo.png" alt="SFC Admin"
                    class="w-10 h-10 rounded-lg object-contain bg-white/10 p-1 shadow-lg">
                <div>
                    <h2 class="font-bold text-sm leading-tight uppercase">Product List</h2>
                    <div class="text-[10px] text-emerald-400 font-medium tracking-wider uppercase">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Code 6
                    </div>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
                <div class="text-[10px] font-bold text-slate-500 uppercase px-3 mb-2 tracking-wider">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</div>
                <button id="navProducts" onclick="switchView('products')"
                    class="nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 bg-slate-800 text-white shadow-md">
                    <span class="w-6 text-center text-lg">üìã</span>
                    <span class="font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                </button>
                <!-- Sub-menu: Product Actions -->
                <div id="productActions" class="space-y-1 mt-1">
                    <button onclick="toggleModal(true)"
                        class="nav-item w-full text-left pl-10 pr-3 py-2 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group">
                        <span class="w-4 text-center text-sm text-emerald-500">‚ûï</span>
                        <span class="text-xs font-medium">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
                    </button>
                    <button onclick="toggleExcelModal(true)"
                        class="nav-item w-full text-left pl-10 pr-3 py-2 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group">
                        <span class="w-4 text-center text-sm text-amber-500">üîç</span>
                        <span class="text-xs font-medium">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Excel</span>
                    </button>
                </div>

                <button id="navBoms" onclick="switchView('boms')"
                    class="nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group mt-1">
                    <span class="w-6 text-center text-lg">üõ†Ô∏è</span>
                    <span class="font-medium">‡πÄ‡∏õ‡∏¥‡∏î BOM CODE</span>
                </button>
                <!-- Sub-menu: BOM Actions -->
                <div id="bomActions" class="space-y-1 mt-1 hidden">
                    <button onclick="toggleBomModal(true)"
                        class="nav-item w-full text-left pl-10 pr-3 py-2 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group">
                        <span class="w-4 text-center text-sm text-emerald-500">‚ûï</span>
                        <span class="text-xs font-medium">‡πÄ‡∏õ‡∏¥‡∏î BOM ‡πÉ‡∏´‡∏°‡πà</span>
                    </button>
                </div>

                <div class="text-[10px] font-bold text-slate-500 uppercase px-3 mb-2 mt-6 tracking-wider">Tools</div>
                <button id="navUsers" onclick="switchView('users')"
                    class="nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group">
                    <span class="w-6 text-center text-lg">üë•</span>
                    <span class="font-medium">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                </button>

                <div class="text-[10px] font-bold text-slate-500 uppercase px-3 mb-2 mt-8 tracking-wider uppercase">
                    ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Cloud</div>
                <button onclick="location.reload()"
                    class="nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group">
                    <span class="w-6 text-center text-lg">üîó</span>
                    <span class="font-medium">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Sheets URL</span>
                </button>

                <div id="sidebarReconnect" class="hidden">
                    <button onclick="reconnectLastFile()"
                        class="nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-emerald-400 hover:bg-emerald-500/10 transition group">
                        <span class="w-6 text-center text-lg">üîÑ</span>
                        <span class="font-medium">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                    </button>
                </div>
            </nav>

            <!-- User Info / Status in Sidebar Bottom -->
            <div class="p-4 bg-slate-800 border-t border-slate-700">
                <div class="flex items-center gap-3 mb-3">
                    <div id="statusDot"
                        class="w-3 h-3 rounded-full bg-slate-500 shadow-[0_0_8px_rgba(149,165,166,0.5)]"></div>
                    <div class="flex-1 min-w-0">
                        <div id="sidebarFileName" class="text-[11px] font-bold truncate text-white uppercase italic">
                            Disconnected</div>
                        <div id="saveStatus" class="text-[9px] text-slate-400 font-medium">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
                    </div>
                </div>
                <button onclick="location.reload()"
                    class="w-full py-2 text-[10px] font-bold bg-slate-700 text-slate-300 rounded hover:bg-slate-600 transition flex items-center justify-center gap-2">
                    <i class="fas fa-power-off"></i> RESET SESSION
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col min-w-0 bg-[#f8fafc] dark:bg-slate-950 overflow-hidden">
            <!-- Header -->
            <header
                class="h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-4 md:px-6 shadow-sm z-10 sticky top-0">
                <div class="flex items-center gap-3 text-slate-700 dark:text-slate-200">
                    <!-- Hamburger Menu Button -->
                    <button onclick="toggleSidebar(true)"
                        class="md:hidden w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                    <span id="mainTitleIcon" class="text-xl opacity-70 hidden sm:inline">üìã</span>
                    <h2 id="mainTitle" class="text-base md:text-lg font-bold truncate">Product List Dashboard</h2>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Last Sync Display -->
                    <div class="flex flex-col items-end leading-tight mr-2 hidden sm:flex">
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Last Synced</div>
                        <div id="lastSyncTime" class="text-xs font-mono font-bold text-emerald-600">-</div>
                    </div>

                    <!-- Manual Save Button -->
                    <button onclick="saveToSheet()" id="headerSaveBtn"
                        class="hidden flex items-center gap-2 px-3 md:px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition shadow-lg shadow-emerald-500/10 group border border-emerald-500">
                        <i class="fas fa-cloud-upload-alt text-sm group-hover:scale-110 transition"></i>
                        <span class="text-[10px] md:text-xs font-bold tracking-wide hidden sm:inline">SYNC TO
                            CLOUD</span>
                    </button>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div id="productDashboard" class="flex-1 overflow-auto p-6 md:p-8 relative fade-in">
                <!-- Product Dashboard Header -->
                <div class="flex items-center gap-4 mb-8">
                    <div
                        class="w-14 h-14 sm:w-16 sm:h-16 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-2xl flex items-center justify-center text-2xl sm:text-3xl shadow-lg shrink-0">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="min-w-0">
                        <div class="flex flex-wrap items-center gap-2 mb-1">
                            <h1
                                class="text-xl sm:text-4xl font-black text-slate-800 dark:text-white leading-tight truncate">
                                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
                            <span
                                class="px-2 py-0.5 bg-emerald-500 text-white text-[9px] font-bold rounded-lg shadow-sm">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <div id="productStatsTop"
                                class="px-2 py-0.5 bg-white dark:bg-slate-900 text-slate-400 text-[9px] font-bold rounded-full border border-slate-200 dark:border-slate-800 shadow-sm uppercase tracking-wider">
                                0 Items</div>
                            <p class="text-slate-400 text-[10px] hidden sm:inline truncate">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Search Container -->
                <div class="max-w-xl mb-8">
                    <label
                        class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1 tracking-wider">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
                    <div class="relative group">
                        <i
                            class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-emerald-500 transition"></i>
                        <input type="text" id="searchInput" oninput="renderProducts()"
                            class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 pl-11 pr-4 py-3 rounded-2xl shadow-sm outline-none focus:ring-4 focus:ring-emerald-500/5 focus:border-emerald-500 transition"
                            placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå CODE ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                    </div>
                </div>

                <!-- Products Table Card -->
                <div
                    class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden mb-12">
                    <div
                        class="p-6 border-b border-slate-50 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/30 flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-lg bg-emerald-500/10 text-emerald-600 flex items-center justify-center">
                                <i class="fas fa-boxes-stacked"></i>
                            </div>
                            <h3 class="font-bold text-slate-800 dark:text-white">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        </div>

                        <div
                            class="flex items-center gap-1 bg-white dark:bg-slate-800 border dark:border-slate-700 p-0.5 rounded-lg shadow-sm">
                            <button onclick="setGroupBy('category')" id="groupBtn_category"
                                class="px-3 py-1 text-[10px] font-bold rounded-[6px] transition bg-emerald-500 text-white shadow-sm">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button>
                            <button onclick="setGroupBy('api')" id="groupBtn_api"
                                class="px-3 py-1 text-[10px] font-bold rounded-[6px] text-slate-400 hover:text-slate-600 transition">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
                                API</button>
                        </div>

                        <div class="flex items-center gap-2">
                            <div id="productCount"
                                class="text-[10px] font-bold px-3 py-1 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-full text-slate-500 uppercase">
                                0 Items</div>
                            <div id="itemICount"
                                class="text-[10px] font-bold px-3 py-1 bg-emerald-50 text-emerald-600 border border-emerald-100 rounded-full uppercase flex items-center gap-1">
                                <i class="fas fa-info-circle"></i> Item I: 0
                            </div>
                            <button onclick="deleteAllProducts()"
                                class="text-[10px] font-bold px-3 py-1 bg-rose-50 text-rose-600 border border-rose-100 rounded-full hover:bg-rose-100 transition uppercase flex items-center gap-1">
                                <i class="fas fa-trash-alt"></i> ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead
                            class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 font-bold text-xs uppercase border-b dark:border-slate-800">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                    CODE</th>
                                <th
                                    class="px-6 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</th>
                                <th
                                    class="px-6 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                    API</th>
                                <th
                                    class="px-6 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                    SAE/ISO</th>
                                <th
                                    class="px-6 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                    BASE OIL</th>
                                <th
                                    class="px-6 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px] w-40">
                                    Item Number</th>
                                <th
                                    class="px-6 py-4 text-center font-bold text-slate-500 uppercase tracking-widest text-[10px] w-28">
                                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="productBody" class="divide-y divide-slate-50 dark:divide-slate-800/50">
                            <!-- Data injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- BOM Dashboard Header -->
            <div id="bomDashboard" class="flex-1 overflow-auto p-6 md:p-8 relative fade-in hidden">
                <div class="flex items-center gap-4 mb-8">
                    <div
                        class="w-14 h-14 sm:w-16 sm:h-16 bg-amber-100 dark:bg-amber-900/30 text-amber-600 rounded-2xl flex items-center justify-center text-2xl sm:text-3xl shadow-lg shrink-0">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="min-w-0">
                        <h1 class="text-2xl sm:text-4xl font-black text-slate-800 dark:text-white mb-1 leading-tight">
                            BOM CODE</h1>
                        <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                            <div id="bomStats"
                                class="px-2 py-0.5 bg-white dark:bg-slate-900 text-slate-400 text-[9px] font-bold rounded-full border border-slate-200 dark:border-slate-800 shadow-sm uppercase tracking-wider">
                                0 Systems</div>
                            <p class="text-slate-400 text-[10px] sm:text-sm truncate">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡∏∞ BOM</p>
                        </div>
                    </div>
                </div>

                <!-- BOM Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <!-- Total BOMs -->
                    <div
                        class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm flex items-center gap-4">
                        <div
                            class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-tight">
                                Total BOM Groups</div>
                            <div id="statTotalBoms"
                                class="text-2xl font-black text-slate-800 dark:text-white leading-tight">0</div>
                        </div>
                    </div>
                    <!-- Active BOMs -->
                    <div
                        class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm flex items-center gap-4">
                        <div
                            class="w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-tight">
                                Active (Approved)</div>
                            <div id="statActiveBoms" class="text-2xl font-black text-emerald-600 leading-tight">0</div>
                        </div>
                    </div>
                    <!-- Pending BOMs -->
                    <div
                        class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm flex items-center gap-4">
                        <div
                            class="w-12 h-12 rounded-2xl bg-amber-50 text-amber-600 flex items-center justify-center text-xl">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-tight">
                                Pending Approval</div>
                            <div id="statPendingBoms" class="text-2xl font-black text-amber-500 leading-tight">0</div>
                        </div>
                    </div>
                </div>

                <!-- BOM Search Container -->
                <div class="max-w-xl mb-8">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1 tracking-wider">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        BOM</label>
                    <div class="relative group">
                        <i
                            class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-emerald-500 transition"></i>
                        <input type="text" id="bomSearchInput" oninput="renderBoms()"
                            class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 pl-11 pr-4 py-3 rounded-2xl shadow-sm outline-none focus:ring-4 focus:ring-emerald-500/5 focus:border-emerald-500 transition"
                            placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå BOM Number ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                    </div>
                </div>

                <!-- BOM Table Card -->
                <div
                    class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden mb-12">
                    <div
                        class="p-6 border-b border-slate-50 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/30 flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-lg bg-emerald-500/10 text-emerald-600 flex items-center justify-center">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                            <h3 class="font-bold text-slate-800 dark:text-white">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ BOM CODE</h3>
                        </div>
                        <div id="bomCount"
                            class="text-[10px] font-bold px-3 py-1 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-full text-slate-500 uppercase">
                            0 BOMs</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead
                                class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 font-bold text-xs uppercase border-b dark:border-slate-800">
                                <tr>
                                    <th
                                        class="px-3 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                        Created</th>
                                    <th
                                        class="px-3 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                        BOM Number</th>
                                    <th
                                        class="px-3 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                        Item Number</th>
                                    <th
                                        class="px-3 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                        Product Name</th>
                                    <th
                                        class="px-3 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                        Created By</th>
                                    <th
                                        class="px-3 py-4 text-left font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                        Approved By</th>
                                    <th
                                        class="px-3 py-4 text-center font-bold text-slate-500 uppercase tracking-widest text-[10px]">
                                        Status</th>
                                </tr>
                            </thead>
                            <tbody id="bomBody" class="divide-y divide-slate-50 dark:divide-slate-800/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Dashboard: User Management -->
            <div id="userDashboard" class="flex-1 overflow-auto p-6 md:p-8 relative fade-in hidden">
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex items-center gap-4 shrink-0 max-w-full">
                            <div
                                class="w-12 h-12 sm:w-14 sm:h-14 rounded-2xl bg-emerald-600 text-white flex items-center justify-center shadow-xl shadow-emerald-500/20 shrink-0">
                                <i class="fas fa-users-cog text-xl sm:text-2xl"></i>
                            </div>
                            <div class="min-w-0">
                                <h1
                                    class="text-xl sm:text-2xl font-black text-slate-800 dark:text-white tracking-tight truncate">
                                    User Management</h1>
                                <div class="flex flex-wrap items-center gap-2 mt-1">
                                    <span id="userCount"
                                        class="px-2 py-0.5 bg-emerald-100 text-emerald-600 text-[9px] font-bold rounded-full uppercase">0
                                        Users</span>
                                    <span
                                        class="text-[9px] text-slate-400 font-medium tracking-widest uppercase truncate">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="toggleUserModal(true)"
                            class="w-full sm:w-auto px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition flex items-center justify-center gap-2 text-sm">
                            <i class="fas fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>

                    <div
                        class="glass rounded-[2rem] shadow-xl border border-white/20 overflow-hidden animate-in fade-in duration-700 delay-200">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/50 dark:bg-slate-800/30">
                                    <th class="px-6 py-4 text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                        ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Name)</th>
                                    <th class="px-6 py-4 text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                        ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Role)</th>
                                    <th class="px-6 py-4 text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                        ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</th>
                                    <th
                                        class="px-6 py-4 text-[11px] font-bold text-slate-400 uppercase tracking-wider text-center">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userBody" class="divide-y divide-slate-50 dark:divide-slate-800/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Add Product (Modern Style) -->
    <div id="addModal"
        class="modal-overlay fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm hidden"
        onclick="handleOverlayClick(event)">
        <div class="glass w-full max-w-2xl p-8 rounded-3xl shadow-2xl relative animate-in fade-in zoom-in duration-300">
            <input type="hidden" id="editProductId" value="">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-emerald-500 text-white flex items-center justify-center shadow-lg">
                        <i id="modalIcon" class="fas fa-plus"></i>
                    </div>
                    <div>
                        <h2 id="modalTitle" class="text-xl font-bold text-slate-800 dark:text-white">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
                        <span id="modalSubtitle"
                            class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">New Inventory
                            Entry</span>
                    </div>
                </div>
                <button onclick="toggleModal(false)"
                    class="w-8 h-8 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
                <div class="space-y-1.5 md:col-span-1">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <input type="text" id="category" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á, ‡∏à‡∏≤‡∏£‡∏∞‡∏ö‡∏µ"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition">
                </div>
                <div class="space-y-1.5 md:col-span-1">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">CODE ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <input type="text" id="code" oninput="checkDuplicateCode()" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition">
                    <div id="codeError"
                        class="hidden text-[10px] text-red-500 font-bold mt-1 px-1 flex items-center gap-1">
                        <i class="fas fa-exclamation-circle"></i> ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                    </div>
                </div>
                <div class="space-y-1.5 md:col-span-2">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
                    <input type="text" id="name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition font-bold">
                </div>
                <div class="space-y-1.5 relative group">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">API Specification</label>
                    <div class="relative">
                        <input type="text" id="api" placeholder="‡πÄ‡∏ä‡πà‡∏ô SP/CF"
                            class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition">
                        <button onclick="toggleApiOptions(event)"
                            class="absolute right-2 top-1/2 -translate-y-1/2 w-7 h-7 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-400 hover:text-emerald-500 hover:border-emerald-500 transition shadow-sm flex items-center justify-center">
                            <i class="fas fa-chevron-down text-[10px]"></i>
                        </button>
                    </div>
                    <!-- API Quick Options Popup -->
                    <div id="apiOptions"
                        class="hidden absolute left-0 right-0 top-full mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-2xl rounded-xl z-[110] max-h-48 overflow-auto py-2 animate-in fade-in slide-in-from-top-2 duration-200">
                        <div class="text-[9px] font-bold text-slate-400 px-3 py-1 uppercase tracking-tighter">‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
                        </div>
                        <div onclick="selectApi('SP / SN PLUS')"
                            class="px-3 py-2 text-xs hover:bg-emerald-50 dark:hover:bg-emerald-900/20 cursor-pointer transition">
                            SP / SN PLUS</div>
                        <div onclick="selectApi('SN / CF')"
                            class="px-3 py-2 text-xs hover:bg-emerald-50 dark:hover:bg-emerald-900/20 cursor-pointer transition">
                            SN / CF</div>
                        <div onclick="selectApi('CK-4')"
                            class="px-3 py-2 text-xs hover:bg-emerald-50 dark:hover:bg-emerald-900/20 cursor-pointer transition">
                            CK-4</div>
                        <div onclick="selectApi('CI-4')"
                            class="px-3 py-2 text-xs hover:bg-emerald-50 dark:hover:bg-emerald-900/20 cursor-pointer transition">
                            CI-4</div>
                        <div id="dynamicApiHeader"
                            class="text-[9px] font-bold text-slate-400 px-3 py-1 mt-2 border-t border-slate-50 dark:border-slate-700 uppercase tracking-tighter">
                            ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        <div id="dynamicApiList"></div>
                    </div>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">SAE / ISO Grade</label>
                    <input type="text" id="sae" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5W-30"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition">
                </div>
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">BASE OIL Type</label>
                    <input type="text" id="base" placeholder="‡πÄ‡∏ä‡πà‡∏ô Fully Synthetic"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition">
                </div>
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">Item Number</label>
                    <input type="text" id="itemNum" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition">
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="toggleModal(false)"
                    class="flex-1 py-3 text-slate-500 font-bold rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveProduct()"
                    class="flex-[2] py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/20 hover:bg-emerald-700 hover:-translate-y-0.5 transition flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: User Management (Add/Edit User) -->
    <div id="userModal"
        class="modal-overlay fixed inset-0 z-[110] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm hidden"
        onclick="if(event.target.id === 'userModal') toggleUserModal(false)">
        <div class="glass w-full max-w-md p-8 rounded-3xl shadow-2xl relative animate-in fade-in zoom-in duration-300">
            <input type="hidden" id="editUserId" value="">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-emerald-500 text-white flex items-center justify-center shadow-lg">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div>
                        <h2 id="userModalTitle" class="text-xl font-bold text-slate-800 dark:text-white">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        </h2>
                        <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">User
                            Management</span>
                    </div>
                </div>
                <button onclick="toggleUserModal(false)"
                    class="w-8 h-8 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4 mb-8">
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="userName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition">
                </div>
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Approve)</label>
                    <input type="password" id="userPassword" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition">
                </div>
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Role)</label>
                    <select id="userRole"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition">
                        <option value="User">User ‡∏õ‡∏Å‡∏ï‡∏¥</option>
                        <option value="Approve">Approve (‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="toggleUserModal(false)"
                    class="flex-1 py-3 text-slate-500 font-bold rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveUser()"
                    class="flex-1 py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Modal: Approval Verification -->
    <div id="approvalModal"
        class="modal-overlay fixed inset-0 z-[120] flex items-center justify-center bg-slate-900/60 backdrop-blur-md hidden"
        onclick="if(event.target.id === 'approvalModal') toggleApprovalModal(false)">
        <div
            class="glass w-full max-w-sm p-8 rounded-3xl shadow-2xl relative animate-in fade-in zoom-in duration-300 border-2 border-blue-500/20">
            <input type="hidden" id="approvalBomId" value="">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 rounded-2xl bg-blue-500 text-white flex items-center justify-center shadow-xl mx-auto mb-4">
                    <i class="fas fa-user-shield text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
                <p class="text-xs text-slate-400 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
            </div>

            <div class="space-y-4 mb-8">
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approved By)</label>
                    <select id="approverSelect"
                        class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ --</option>
                    </select>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label>
                    <input type="password" id="approvalPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition text-center tracking-widest">
                </div>
                <div id="approvalError" class="hidden text-[10px] text-red-500 font-bold text-center italic">
                    <i class="fas fa-times-circle"></i> ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <button onclick="confirmApproval()"
                    class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <i class="fas fa-check-double"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ACTIVE
                </button>
                <button onclick="toggleApprovalModal(false)"
                    class="w-full py-3 text-slate-400 text-[11px] font-bold hover:text-slate-600 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            </div>
        </div>
    </div>

    <!-- Modal: BOM Detail Viewer [NEW] -->
    <div id="bomDetailModal"
        class="modal-overlay fixed inset-0 z-[110] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden"
        onclick="if(event.target.id === 'bomDetailModal') toggleBomDetailModal(false)">
        <div
            class="glass w-full max-w-4xl p-8 rounded-3xl shadow-2xl relative animate-in fade-in zoom-in duration-300 border border-white/20">
            <div class="flex justify-between items-start mb-6">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 flex items-center justify-center shadow-inner">
                        <i class="fas fa-file-invoice text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î BOM</h2>
                        <div id="detailStatusBadge" class="mt-1"></div>
                    </div>
                </div>
                <button onclick="toggleBomDetailModal(false)" class="text-slate-400 hover:text-slate-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div id="bomDetailContent" class="grid grid-cols-1 md:grid-cols-2 gap-y-6 md:gap-y-4 gap-x-6 text-sm mb-8">
                <!-- Data will be injected here -->
            </div>

            <div class="flex flex-wrap gap-2 pt-6 border-t border-slate-100 dark:border-slate-800"
                id="detailModalActions">
                <!-- Action buttons will be injected here -->
            </div>
            <div class="mt-4 text-center">
                <button onclick="toggleBomDetailModal(false)"
                    class="text-[11px] font-bold text-slate-400 hover:text-slate-600 uppercase tracking-widest transition">
                    ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Add BOM (Modern Style) -->
    <div id="bomModal"
        class="modal-overlay fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm hidden"
        onclick="if(event.target.id === 'bomModal') toggleBomModal(false)">
        <div
            class="glass w-full max-w-6xl p-6 md:p-8 rounded-3xl shadow-2xl relative animate-in fade-in zoom-in duration-300 mx-4 overflow-hidden">
            <input type="hidden" id="editBomId" value="">
            <input type="hidden" id="bomParentId" value="">

            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-emerald-500 text-white flex items-center justify-center shadow-lg">
                        <i id="bomModalIcon" class="fas fa-plus"></i>
                    </div>
                    <div>
                        <h2 id="bomModalTitle" class="text-xl font-bold text-slate-800 dark:text-white">‡πÄ‡∏õ‡∏¥‡∏î BOM CODE
                            ‡πÉ‡∏´‡∏°‡πà</h2>
                        <span id="bomModalSubtitle"
                            class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">New BOM Entry</span>
                    </div>
                </div>
                <button onclick="toggleBomModal(false)"
                    class="w-8 h-8 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Two-Column Layout Container -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">

                <!-- Left Column: Main BOM Details (Span 7) -->
                <div class="lg:col-span-7 space-y-5">
                    <div
                        class="bg-white dark:bg-slate-900/40 p-5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-slate-50 dark:border-slate-800">
                            <i class="fas fa-info-circle text-emerald-500"></i>
                            <span
                                class="text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
                                (Main Info)</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1.5">
                                <label class="text-[11px] font-bold text-slate-500 ml-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Created</label>
                                <input type="date" id="bomCreated"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition text-sm">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[11px] font-bold text-slate-500 ml-1">BOM Number</label>
                                <input type="text" id="bomNumber" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà BOM"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition text-sm font-mono font-bold">
                            </div>
                            <div class="space-y-1.5 relative">
                                <label class="text-[11px] font-bold text-slate-500 ml-1">Item Number</label>
                                <div class="relative">
                                    <input type="text" id="bomItemNum" oninput="suggestProducts(this.value)"
                                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏≠‡πÄ‡∏ó‡∏°"
                                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition font-mono font-bold text-sm text-emerald-600">
                                    <div id="productSuggestions"
                                        class="hidden absolute left-0 right-0 top-full mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-2xl rounded-xl z-[110] max-h-48 overflow-auto py-2">
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[11px] font-bold text-slate-500 ml-1">Product Name</label>
                                <input type="text" id="bomProductName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition text-sm font-bold text-slate-700 dark:text-slate-200">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[11px] font-bold text-slate-500 ml-1">Pack Size</label>
                                <input type="text" id="bomPackSize" placeholder="‡πÄ‡∏ä‡πà‡∏ô 200L"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition text-sm">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[11px] font-bold text-slate-500 ml-1">Quantity / Unit</label>
                                <div class="flex gap-2">
                                    <input type="number" id="bomQuantity" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"
                                        class="flex-[2] bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition text-sm">
                                    <select id="bomUnit"
                                        class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition text-sm font-bold text-emerald-600">
                                        <option value="L">L</option>
                                        <option value="Kg">Kg</option>
                                    </select>
                                </div>
                            </div>
                            <div class="space-y-1.5 md:col-span-2">
                                <label class="text-[11px] font-bold text-slate-500 ml-1">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ (Created By)</label>
                                <select id="bomCreatedBy"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition text-sm">
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ --</option>
                                </select>
                            </div>
                            <div class="space-y-1.5 md:col-span-2">
                                <label class="text-[11px] font-bold text-slate-500 ml-1">Remark</label>
                                <textarea id="bomRemark" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2.5 rounded-xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition text-sm"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Free Gift Management (Span 5) -->
                <div id="modalGiftSection" class="lg:col-span-5 space-y-5">
                    <div
                        class="bg-amber-50/30 dark:bg-amber-900/5 p-5 rounded-2xl border border-amber-100/50 dark:border-amber-900/20 shadow-sm h-full flex flex-col">
                        <div
                            class="flex justify-between items-center mb-4 pb-2 border-b border-amber-100/50 dark:border-amber-900/10">
                            <label
                                class="text-xs font-bold text-amber-600 uppercase tracking-widest flex items-center gap-2">
                                <i class="fas fa-gift"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏° (Free Gifts)
                            </label>
                            <button onclick="toggleAddGiftInModal(true)" id="btnAddGiftInModal"
                                class="px-3 py-1 bg-emerald-500/10 text-emerald-600 hover:bg-emerald-500 hover:text-white rounded-lg text-[10px] font-bold transition flex items-center gap-1">
                                <i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°
                            </button>
                        </div>

                        <!-- Gift Input Panel (Dynamic) -->
                        <div id="giftInputArea"
                            class="hidden bg-white dark:bg-slate-900 p-4 rounded-xl border border-amber-200 dark:border-amber-900/40 mb-4 shadow-xl animate-in fade-in slide-in-from-right-4 duration-300">
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="col-span-2 relative">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">Item Number</label>
                                    <input type="text" id="giftItemNum" oninput="suggestGifts(this.value)"
                                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏≠‡πÄ‡∏ó‡∏°"
                                        class="w-full border-b-2 border-slate-100 dark:border-slate-800 p-1.5 text-xs outline-none focus:border-amber-500 transition font-mono bg-transparent">
                                    <div id="giftSuggestions"
                                        class="hidden absolute left-0 right-0 top-full mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-2xl rounded-lg z-[130] max-h-32 overflow-auto py-1 text-xs">
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">Product Name</label>
                                    <input type="text" id="giftProductName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
                                        class="w-full border-b-2 border-slate-100 dark:border-slate-800 p-1.5 text-xs outline-none focus:border-amber-500 transition bg-transparent">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">Pack Size</label>
                                    <input type="text" id="giftPackSize" placeholder="‡πÄ‡∏ä‡πà‡∏ô 200L"
                                        class="w-full border-b-2 border-slate-100 dark:border-slate-800 p-1.5 text-xs outline-none focus:border-amber-500 transition bg-transparent">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">Qty</label>
                                    <input type="number" id="giftQty" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"
                                        class="w-full border-b-2 border-slate-100 dark:border-slate-800 p-1.5 text-xs outline-none focus:border-amber-500 transition bg-transparent">
                                </div>
                                <div class="col-span-2">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">Remark
                                        (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏)</label>
                                    <textarea id="giftRemark" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" rows="1"
                                        class="w-full border-b-2 border-slate-100 dark:border-slate-800 p-1.5 text-xs outline-none focus:border-amber-500 transition bg-transparent resize-none"></textarea>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="addGiftToList()" id="btnConfirmGift"
                                    class="flex-1 py-1.5 bg-amber-500 text-white text-[11px] font-bold rounded-lg hover:bg-amber-600 transition shadow-md shadow-amber-500/20">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                                <button onclick="toggleAddGiftInModal(false)"
                                    class="flex-1 py-1.5 text-slate-400 text-[11px] font-bold hover:text-slate-600 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            </div>
                        </div>

                        <!-- Gift List Wrapper -->
                        <div id="modalGiftList"
                            class="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-1 min-h-[100px]">
                            <!-- Placeholder when empty -->
                            <div id="emptyGiftHint"
                                class="h-full flex flex-col items-center justify-center text-slate-300 dark:text-slate-700 italic space-y-2 py-8">
                                <i class="fas fa-gift text-3xl opacity-20"></i>
                                <span class="text-[11px] font-medium opacity-50">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-row-reverse gap-4 pt-6 border-t border-slate-100 dark:border-slate-800">
                <button onclick="toggleBomModal(false)"
                    class="px-8 py-3 text-slate-400 font-bold rounded-2xl hover:bg-slate-100 dark:hover:bg-slate-800 transition text-sm">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button onclick="saveBom()"
                    class="flex-1 py-3 bg-emerald-600 text-white font-bold rounded-2xl shadow-xl shadow-emerald-500/20 hover:bg-emerald-700 hover:-translate-y-0.5 active:translate-y-0 transition flex items-center justify-center gap-2 text-sm uppercase tracking-widest">
                    <i class="fas fa-save font-normal"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BOM ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Excel Checker -->
    <div id="excelModal"
        class="modal-overlay fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm hidden"
        onclick="if(event.target.id === 'excelModal') toggleExcelModal(false)">
        <div class="glass w-full max-w-3xl p-8 rounded-3xl shadow-2xl relative animate-in fade-in zoom-in duration-300">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-amber-500 text-white flex items-center justify-center shadow-lg">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å
                            Excel
                        </h2>
                        <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Excel Data
                            Comparison Tool</span>
                    </div>
                </div>
                <button onclick="toggleExcelModal(false)"
                    class="w-8 h-8 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Upload Area -->
            <div id="excelDropZone"
                class="w-full py-12 px-4 rounded-2xl border-2 border-dashed border-amber-300 bg-amber-50/20 hover:bg-white hover:border-amber-500 transition-all flex flex-col items-center justify-center gap-3 cursor-pointer mb-6"
                onclick="document.getElementById('excelInput').click()">
                <div class="w-16 h-16 rounded-full bg-white flex items-center justify-center shadow-sm">
                    <i class="fas fa-cloud-upload-alt text-3xl text-amber-500"></i>
                </div>
                <div class="text-center">
                    <div class="text-sm font-bold text-slate-700">‡∏Ñ‡∏•‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                    <div class="text-[10px] text-slate-400 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "CODE"
                        ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
                    </div>
                </div>
                <input type="file" id="excelInput" class="hidden" accept=".xlsx, .xls"
                    onchange="handleExcelUpload(event)">
            </div>

            <!-- Result Area -->
            <div id="excelResultArea" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div class="flex flex-col">
                        <h4 class="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                            <i class="fas fa-list"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: <span id="excelFileName"
                                class="text-slate-800"></span>
                        </h4>
                        <button onclick="resetExcelChecker()"
                            class="w-fit mt-1 text-[10px] font-bold text-emerald-600 hover:text-emerald-700 flex items-center gap-1 transition">
                            <i class="fas fa-sync-alt"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>

                    <!-- Tabs UI -->
                    <div
                        class="flex items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-xl shadow-inner self-stretch sm:self-auto">
                        <button onclick="switchExcelTab('new')" id="excelTabBtn_new"
                            class="flex-1 sm:flex-none px-4 py-2 text-[10px] font-bold rounded-lg transition-all duration-200 bg-white dark:bg-slate-700 text-emerald-600 shadow-sm flex items-center justify-center gap-2">
                            <i class="fas fa-sparkles"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà <span id="countNew" class="opacity-60">0</span>
                        </button>
                        <button onclick="switchExcelTab('dup')" id="excelTabBtn_dup"
                            class="flex-1 sm:flex-none px-4 py-2 text-[10px] font-bold rounded-lg transition-all duration-200 text-slate-400 hover:text-slate-600 flex items-center justify-center gap-2 border-transparent">
                            <i class="fas fa-copy"></i> ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß <span id="countDup" class="opacity-60">0</span>
                        </button>
                    </div>
                </div>

                <!-- New Items Alert & Bulk Action -->
                <div id="newItemsAlert"
                    class="hidden mb-6 p-4 bg-emerald-50 border border-emerald-100 rounded-2xl flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-emerald-500 text-white flex items-center justify-center shadow-md">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-emerald-800">‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå!</div>
                            <div class="text-[10px] text-emerald-600 font-medium">
                                ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
                        </div>
                    </div>
                    <button id="bulkAddBtn" onclick="bulkAddFromExcel()"
                        class="px-4 py-2 bg-emerald-600 text-white text-xs font-bold rounded-xl shadow-lg shadow-emerald-600/20 hover:bg-emerald-700 transition flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </button>
                </div>

                <div id="excelNewTabContent" class="fade-in">
                    <div class="max-h-[300px] overflow-auto border border-slate-100 dark:border-slate-800 rounded-xl">
                        <table class="w-full text-[13px]">
                            <thead class="bg-slate-50 dark:bg-slate-800 sticky top-0 font-bold text-slate-500 border-b">
                                <tr>
                                    <th class="px-4 py-3 text-left w-10">
                                        <input type="checkbox" id="selectAllExcel"
                                            onchange="toggleSelectAllExcel(this.checked)" checked
                                            class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500 transition">
                                    </th>
                                    <th class="px-4 py-3 text-left">CODE ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th class="px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå)</th>
                                    <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="excelResultBody" class="divide-y divide-slate-50 dark:divide-slate-800/50">
                                <!-- Comparison result here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="excelDupTabContent" class="hidden fade-in">
                    <div class="max-h-[300px] overflow-auto border border-slate-100 dark:border-slate-800 rounded-xl">
                        <table class="w-full text-[13px]">
                            <thead class="bg-slate-50 dark:bg-slate-800 sticky top-0 font-bold text-slate-500 border-b">
                                <tr>
                                    <th class="px-4 py-3 text-left">CODE ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th class="px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå)</th>
                                    <th class="px-4 py-3 text-center italic opacity-60">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody id="excelDupBody" class="divide-y divide-slate-50 dark:divide-slate-800/50">
                                <!-- Existing items here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button onclick="toggleExcelModal(false)"
                    class="px-6 py-2.5 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <!-- UI Logics -->
    <script>
        let products = [];
        let boms = [];
        let users = []; // [{id, name, password}]
        let currentView = 'products'; // 'products', 'boms', or 'users'
        let fileHandle = null;
        let pendingExcelItems = []; // Store new items from Excel for bulk add
        let currentGroupBy = 'category'; // 'category' or 'api'
        let collapsedGroups = new Set(); // Store collapsed group names
        let tempFreeGifts = []; // Temporarily store gifts being added in modal
        let editingGiftIdx = -1; // Track which gift is being edited in the list
        let shouldReturnToDetail = false; // Track if we should go back to detail after edit

        // --- View Switching ---
        function switchView(view) {
            currentView = view;
            const isProd = view === 'products';
            const isBom = view === 'boms';
            const isUsers = view === 'users';

            document.getElementById('productDashboard').classList.toggle('hidden', !isProd);
            document.getElementById('bomDashboard').classList.toggle('hidden', !isBom);
            document.getElementById('userDashboard').classList.toggle('hidden', !isUsers);

            document.getElementById('productActions').classList.toggle('hidden', !isProd);
            document.getElementById('bomActions').classList.toggle('hidden', !isBom);

            // Update Header Title
            const mainTitle = document.getElementById('mainTitle');
            const mainIcon = document.getElementById('mainTitleIcon');
            if (isProd) {
                mainTitle.innerText = "Product List Dashboard";
                mainIcon.innerText = "üìã";
            } else if (isBom) {
                mainTitle.innerText = "BOM Management";
                mainIcon.innerText = "üõ†Ô∏è";
            } else if (isUsers) {
                mainTitle.innerText = "User Management Settings";
                mainIcon.innerText = "üë•";
            }

            // Update Sidebar UI
            const navP = document.getElementById('navProducts');
            const navB = document.getElementById('navBoms');
            const navU = document.getElementById('navUsers');

            navP.className = isProd ? "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 bg-slate-800 text-white shadow-md active" : "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group";
            navB.className = isBom ? "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 bg-slate-800 text-white shadow-md active" : "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group";
            navU.className = isUsers ? "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 bg-slate-800 text-white shadow-md active" : "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group";

            if (isProd) renderProducts();
            if (isBom) renderBoms();
            if (isUsers) renderUsers();
        }

        function getToday() {
            const d = new Date();
            return [d.getFullYear(), String(d.getMonth() + 1).padStart(2, '0'), String(d.getDate()).padStart(2, '0')].join('-');
        }

        function cleanDate(d) {
            if (!d) return '';
            const dt = new Date(d);
            if (isNaN(dt.getTime())) return String(d);
            const y = dt.getFullYear();
            const m = String(dt.getMonth() + 1).padStart(2, '0');
            const day = String(dt.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        // --- User Management Helpers ---
        function toggleUserModal(show) {
            const m = document.getElementById('userModal');
            m.classList.toggle('hidden', !show);
            if (show) {
                if (!document.getElementById('editUserId').value) {
                    document.getElementById('userModalTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
                    document.getElementById('userName').value = '';
                    document.getElementById('userPassword').value = '';
                    document.getElementById('userRole').value = 'User';
                }
                document.getElementById('userName').focus();
            } else {
                document.getElementById('editUserId').value = '';
            }
        }

        function renderUsers() {
            const body = document.getElementById('userBody');
            const count = document.getElementById('userCount');
            if (!body) return;
            body.innerHTML = '';

            if (users.length === 0) {
                body.innerHTML = `<tr><td colspan="4" class="px-6 py-10 text-center text-slate-400 italic bg-slate-50/10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</td></tr>`;
            } else {
                users.forEach(u => {
                    const isApprove = u.role === 'Approve';
                    const r = document.createElement('tr');
                    r.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors";
                    r.innerHTML = `
                                <td class="px-6 py-4 font-bold text-slate-700 dark:text-slate-300 whitespace-nowrap">${u.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase ${isApprove ? 'bg-blue-100 text-blue-600 border border-blue-200' : 'bg-slate-100 text-slate-500 border border-slate-200'}">
                                        <i class="fas ${isApprove ? 'fa-user-shield' : 'fa-user'} mr-1"></i> ${u.role || 'User'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-slate-400 font-mono whitespace-nowrap">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                                <td class="px-6 py-4 text-center whitespace-nowrap">
                                    <div class="flex items-center justify-center gap-2">
                                        <button onclick="openEditUserModal('${u.id}')" class="w-8 h-8 rounded-lg border border-emerald-200 text-emerald-500 hover:bg-emerald-500 hover:text-white transition shadow-sm">
                                            <i class="fas fa-edit text-xs"></i>
                                        </button>
                                        <button onclick="deleteUser('${u.id}')" class="w-8 h-8 rounded-lg border border-red-200 text-red-500 hover:bg-red-500 hover:text-white transition shadow-sm">
                                            <i class="fas fa-trash-alt text-xs"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                    body.appendChild(r);
                });
            }
            if (count) count.innerText = `${users.length} Users`;
            populateUserDropdowns();
        }

        function openEditUserModal(id) {
            const u = users.find(x => String(x.id) === String(id));
            if (!u) return;
            document.getElementById('editUserId').value = u.id;
            document.getElementById('userName').value = u.name;
            document.getElementById('userPassword').value = u.password;
            document.getElementById('userRole').value = u.role || 'User';
            document.getElementById('userModalTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            toggleUserModal(true);
        }

        async function saveUser() {
            const id = document.getElementById('editUserId').value;
            const name = document.getElementById('userName').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            const role = document.getElementById('userRole').value;
            if (!name || !password) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');

            if (id) {
                const idx = users.findIndex(u => String(u.id) === String(id));
                if (idx !== -1) users[idx] = { ...users[idx], name, password, role };
            } else {
                users.push({ id: Date.now().toString(), name, password, role });
            }

            renderUsers();
            toggleUserModal(false);
            document.getElementById('editUserId').value = '';

            if (sheetUrl) {
                await saveToSheet();
            }
        }

        function deleteUser(id) {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô?')) return;
            users = users.filter(u => String(u.id) !== String(id));
            renderUsers();
            saveToSheet();
        }

        function populateUserDropdowns() {
            const creatorSelect = document.getElementById('bomCreatedBy');
            const approverSelect = document.getElementById('approverSelect');
            if (!creatorSelect || !approverSelect) return;

            const creatorVal = creatorSelect.value;
            creatorSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ --</option>';
            approverSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ --</option>';
            users.forEach(u => {
                creatorSelect.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                if (u.role === 'Approve') {
                    approverSelect.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                }
            });
            creatorSelect.value = creatorVal;
        }

        function toggleApprovalModal(show, bomId = '') {
            const m = document.getElementById('approvalModal');
            m.classList.toggle('hidden', !show);
            document.getElementById('approvalError').classList.add('hidden');
            if (show) {
                document.getElementById('approvalBomId').value = bomId;
                document.getElementById('approvalPassword').value = '';
                document.getElementById('approverSelect').value = '';
            }
        }

        async function confirmApproval() {
            const bomId = document.getElementById('approvalBomId').value;
            const approverName = document.getElementById('approverSelect').value.trim();
            const password = document.getElementById('approvalPassword').value.trim();

            if (!approverName || !password) {
                return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            }

            const user = users.find(u => String(u.name || '').trim() === approverName);

            if (!user) {
                return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }

            if (String(user.password || '').trim() !== password) {
                document.getElementById('approvalError').innerText = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                document.getElementById('approvalError').classList.remove('hidden');
                return;
            }

            if (user.role !== 'Approve') {
                document.getElementById('approvalError').innerText = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Role Approve Only)';
                document.getElementById('approvalError').classList.remove('hidden');
                return;
            }

            const b = boms.find(x => String(x.id) === String(bomId));
            if (b) {
                try {
                    // Approve Main BOM
                    b.status = 'Active';
                    b.approvedBy = approverName;

                    // Also Approve all linked Free Items (Children)
                    boms.forEach(item => {
                        if (String(item.parentId) === String(bomId)) {
                            item.status = 'Active';
                            item.approvedBy = approverName;
                        }
                    });

                    renderBoms();
                    toggleApprovalModal(false);
                    if (sheetUrl) await saveToSheet();
                } catch (err) {
                    console.error('Error during approval:', err);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err.message);
                }
            } else {
                console.error('Cannot find BOM with ID:', bomId);
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ BOM ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (ID: ' + bomId + ') ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }
        }

        // --- BOM Helpers ---
        function toggleBomModal(show) {
            const m = document.getElementById('bomModal');
            const editId = document.getElementById('editBomId').value;

            if (!show) {
                m.classList.add('hidden');
                // Return to detail if it was an edit originating from there
                if (shouldReturnToDetail && editId) {
                    toggleBomDetailModal(true, editId);
                }
                shouldReturnToDetail = false; // Reset

                // Clear fields
                const fields = ['editBomId', 'bomParentId', 'bomCreated', 'bomNumber', 'bomItemNum', 'bomProductName', 'bomPackSize', 'bomQuantity', 'bomUnit', 'bomRemark', 'bomCreatedBy'];
                fields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = id === 'bomUnit' ? 'L' : '';
                });
                document.getElementById('bomModalTitle').innerText = '‡πÄ‡∏õ‡∏¥‡∏î BOM CODE ‡πÉ‡∏´‡∏°‡πà';
                document.getElementById('bomModalSubtitle').innerText = 'New BOM Entry';
                document.getElementById('bomModalIcon').className = 'fas fa-plus';
                document.getElementById('bomNumber').disabled = false;
                document.getElementById('modalGiftSection').classList.toggle('hidden', false);
                tempFreeGifts = [];
                renderTempGifts();
                return;
            }

            m.classList.remove('hidden');
            if (!document.getElementById('editBomId').value && !document.getElementById('bomParentId').value) {
                document.getElementById('bomCreated').value = getToday();
            }
            const bNumInput = document.getElementById('bomNumber');
            if (!document.getElementById('bomParentId').value) bNumInput.disabled = false;
            bNumInput.focus();
        }

        function toggleAddGiftInModal(show, idx = -1) {
            const area = document.getElementById('giftInputArea');
            area.classList.toggle('hidden', !show);
            editingGiftIdx = idx;

            if (show) {
                if (idx !== -1) {
                    const g = tempFreeGifts[idx];
                    document.getElementById('giftItemNum').value = g.itemNum || '';
                    document.getElementById('giftProductName').value = g.productName || '';
                    document.getElementById('giftPackSize').value = g.packSize || '';
                    document.getElementById('giftQty').value = g.quantity || '';
                    document.getElementById('giftRemark').value = g.remark || '';
                    document.getElementById('btnConfirmGift').innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                } else {
                    document.getElementById('giftItemNum').value = '';
                    document.getElementById('giftProductName').value = '';
                    document.getElementById('giftPackSize').value = '';
                    document.getElementById('giftQty').value = '';
                    document.getElementById('giftRemark').value = '';
                    document.getElementById('btnConfirmGift').innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                    document.getElementById('giftItemNum').focus();
                }
            }
        }

        function suggestGifts(val) {
            const sug = document.getElementById('giftSuggestions');
            if (val.length < 2) { sug.classList.add('hidden'); return; }

            const matches = products.filter(p =>
                String(p.itemNum || '').toLowerCase().includes(val.toLowerCase()) ||
                String(p.code || '').toLowerCase().includes(val.toLowerCase())
            ).slice(0, 5);

            if (matches.length === 0) { sug.classList.add('hidden'); return; }

            sug.innerHTML = matches.map(p => `
                        <div onclick="selectGiftSuggestion('${p.itemNum}', '${p.name.replace(/'/g, "\\'")}')" 
                            class="px-3 py-2 hover:bg-amber-50 dark:hover:bg-amber-900/20 cursor-pointer border-b last:border-0 border-slate-50 dark:border-slate-700">
                            <div class="font-bold text-amber-600">${p.itemNum}</div>
                            <div class="text-[10px] text-slate-500">${p.name}</div>
                        </div>
                    `).join('');
            sug.classList.remove('hidden');
        }

        function selectGiftSuggestion(itemNum, name) {
            document.getElementById('giftItemNum').value = itemNum;
            document.getElementById('giftProductName').value = name;
            document.getElementById('giftSuggestions').classList.add('hidden');
        }

        function addGiftToList() {
            const itemNum = document.getElementById('giftItemNum').value.trim();
            const productName = document.getElementById('giftProductName').value.trim();
            const packSize = document.getElementById('giftPackSize').value.trim();
            const quantity = document.getElementById('giftQty').value.trim();
            const remark = document.getElementById('giftRemark').value.trim();

            if (!itemNum || !productName) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°');

            const giftData = {
                itemNum,
                productName,
                packSize,
                quantity,
                remark,
                id: editingGiftIdx !== -1 ? tempFreeGifts[editingGiftIdx].id : 'temp_' + Date.now()
            };

            if (editingGiftIdx !== -1) {
                tempFreeGifts[editingGiftIdx] = giftData;
            } else {
                tempFreeGifts.push(giftData);
            }

            renderTempGifts();
            toggleAddGiftInModal(false);
        }

        function removeTempGift(idx) {
            tempFreeGifts.splice(idx, 1);
            renderTempGifts();
        }

        function renderTempGifts() {
            const list = document.getElementById('modalGiftList');
            if (!list) return;

            list.innerHTML = '';

            if (tempFreeGifts.length === 0) {
                list.innerHTML = `
                    <div id="emptyGiftHint" class="h-full flex flex-col items-center justify-center text-slate-300 dark:text-slate-700 italic space-y-2 py-8">
                        <i class="fas fa-gift text-3xl opacity-20"></i>
                        <span class="text-[11px] font-medium opacity-50">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°</span>
                    </div>
                `;
                return;
            }

            tempFreeGifts.forEach((g, i) => {
                const item = document.createElement('div');
                item.className = "group bg-white dark:bg-slate-800/80 p-3 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm hover:border-amber-200 dark:hover:border-amber-900/40 transition-all flex justify-between items-center animate-in fade-in slide-in-from-right-2 duration-300";
                item.innerHTML = `
                    <div class="flex-1 min-w-0 pr-3">
                        <div class="text-[11px] font-bold text-slate-700 dark:text-slate-200 truncate">${g.productName}</div>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-[9px] font-mono text-amber-600 bg-amber-50 dark:bg-amber-900/20 px-1.5 py-0.5 rounded">${g.itemNum}</span>
                            <span class="text-[9px] text-slate-400 font-bold">${g.packSize} x ${g.quantity}</span>
                        </div>
                        ${g.remark ? `<div class="text-[9px] text-slate-400 italic mt-1 border-t border-slate-50 pt-1">${g.remark}</div>` : ''}
                    </div>
                    <div class="flex items-center gap-1 shrink-0">
                        <button onclick="toggleAddGiftInModal(true, ${i})" class="w-7 h-7 flex items-center justify-center rounded-lg text-slate-300 hover:text-amber-500 hover:bg-amber-50 transition-colors">
                            <i class="fas fa-edit text-[10px]"></i>
                        </button>
                        <button onclick="removeTempGift(${i})" class="w-7 h-7 flex items-center justify-center rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function addFreeItem(parentId) {
            const p = boms.find(b => String(b.id) === String(parentId));
            if (!p) return;

            document.getElementById('editBomId').value = '';
            document.getElementById('bomParentId').value = parentId;

            toggleBomModal(true);
            document.getElementById('bomModalTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°';
            document.getElementById('bomModalSubtitle').innerText = 'Add Free Item to BOM';
            document.getElementById('bomModalIcon').className = 'fas fa-gift';

            document.getElementById('bomCreated').value = cleanDate(p.created) || getToday();
            document.getElementById('bomNumber').value = p.bomNumber || '';
            document.getElementById('bomNumber').disabled = true;
        }

        function suggestProducts(val) {
            const sug = document.getElementById('productSuggestions');
            if (val.length < 2) { sug.classList.add('hidden'); return; }

            const matches = products.filter(p =>
                String(p.itemNum || '').toLowerCase().includes(val.toLowerCase()) ||
                String(p.code || '').toLowerCase().includes(val.toLowerCase())
            ).slice(0, 5);

            if (matches.length === 0) { sug.classList.add('hidden'); return; }

            sug.innerHTML = matches.map(p => `
                <div onclick="selectProductSuggestion('${p.itemNum}', '${p.name.replace(/'/g, "\\'")}')" 
                    class="px-3 py-2 text-xs hover:bg-emerald-50 dark:hover:bg-emerald-900/20 cursor-pointer transition flex flex-col">
                    <span class="font-bold text-emerald-600">${p.itemNum}</span>
                    <span class="text-[10px] text-slate-500">${p.name}</span>
                </div>
            `).join('');
            sug.classList.remove('hidden');
        }

        function selectProductSuggestion(itemNum, name) {
            document.getElementById('bomItemNum').value = itemNum;
            document.getElementById('bomProductName').value = name;
            document.getElementById('productSuggestions').classList.add('hidden');
        }

        // --- Core Helpers ---
        function toggleModal(show) {
            const m = document.getElementById('addModal');
            m.classList.toggle('hidden', !show);
            if (show) {
                document.getElementById('category').focus();
            } else {
                // Clear fields when closing
                const fields = ['editProductId', 'category', 'code', 'name', 'api', 'sae', 'base', 'itemNum'];
                fields.forEach(id => document.getElementById(id).value = '');

                // Reset Modal to Add mode
                document.getElementById('modalTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
                document.getElementById('modalSubtitle').innerText = 'New Inventory Entry';
                document.getElementById('modalIcon').className = 'fas fa-plus';
                document.getElementById('code').disabled = false;
            }
        }
        function toggleExcelModal(show) {
            const m = document.getElementById('excelModal');
            m.classList.toggle('hidden', !show);
            if (!show) {
                document.getElementById('excelResultArea').classList.add('hidden');
                document.getElementById('excelDropZone').classList.remove('hidden');
            }
        }
        function handleOverlayClick(e) {
            if (e.target.id === 'addModal') toggleModal(false);
            // Close API options if click outside
            if (!e.target.closest('#apiOptions') && !e.target.closest('button[onclick="toggleApiOptions(event)"]')) {
                document.getElementById('apiOptions').classList.add('hidden');
            }
        }

        function toggleApiOptions(e) {
            e.stopPropagation();
            const pop = document.getElementById('apiOptions');
            const show = pop.classList.contains('hidden');
            pop.classList.toggle('hidden', !show);

            if (show) {
                // Populate dynamic list
                const dynamicHeader = document.getElementById('dynamicApiHeader');
                const dynamicList = document.getElementById('dynamicApiList');
                const uniqueApis = [...new Set(products.map(p => p.api).filter(v => v && v !== '-').sort())];

                dynamicList.innerHTML = '';
                if (uniqueApis.length === 0) {
                    dynamicHeader.classList.add('hidden');
                } else {
                    dynamicHeader.classList.remove('hidden');
                    uniqueApis.forEach(api => {
                        const div = document.createElement('div');
                        div.className = "px-3 py-2 text-xs hover:bg-emerald-50 dark:hover:bg-emerald-900/20 cursor-pointer transition";
                        div.innerText = api;
                        div.onclick = () => selectApi(api);
                        dynamicList.appendChild(div);
                    });
                }
            }
        }

        function selectApi(val) {
            document.getElementById('api').value = val;
            document.getElementById('apiOptions').classList.add('hidden');
        }

        function openEditModal(id) {
            const p = products.find(prod => String(prod.id) === String(id));
            if (!p) return;

            toggleModal(true);

            // Set UI to Edit mode
            document.getElementById('modalTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            document.getElementById('modalSubtitle').innerText = 'Edit Inventory Entry';
            document.getElementById('modalIcon').className = 'fas fa-edit';

            // Fill fields
            document.getElementById('editProductId').value = p.id;
            document.getElementById('category').value = p.category || '';
            document.getElementById('code').value = p.code || '';
            document.getElementById('name').value = p.name || '';
            document.getElementById('api').value = p.api || '';
            document.getElementById('sae').value = p.sae || '';
            document.getElementById('base').value = p.base || '';
            document.getElementById('itemNum').value = p.itemNum || '';

            // Optional: Disable code editing if you want it unique/fixed
            // document.getElementById('code').disabled = true;

            checkDuplicateCode();
        }

        // --- Cloud Storage Layer (Google Sheets) ---
        let sheetUrl = "";

        async function openIDB() {
            return new Promise((res) => {
                const r = indexedDB.open('SFC_PRODUCT_CLOUD_CONFIG', 1);
                r.onupgradeneeded = () => r.result.createObjectStore('config');
                r.onsuccess = () => res(r.result);
            });
        }
        async function saveSheetUrl(url) {
            const db = await openIDB();
            const tx = db.transaction('config', 'readwrite');
            tx.objectStore('config').put(url, 'sheet_url');
            return new Promise(r => tx.oncomplete = r);
        }
        async function getSavedUrl() {
            const db = await openIDB();
            return new Promise(r => {
                const req = db.transaction('config', 'readonly').objectStore('config').get('sheet_url');
                req.onsuccess = () => r(req.result);
            });
        }

        // --- Core Helpers ---
        function updateUIStatus(connected) {
            const dot = document.getElementById('statusDot');
            const sideName = document.getElementById('sidebarFileName');
            const sideStat = document.getElementById('saveStatus');
            const headerBtn = document.getElementById('headerSaveBtn');

            if (connected) {
                dot.className = 'w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(39,174,96,0.6)]';
                sideName.innerText = 'Cloud Connected';
                sideStat.innerText = 'Google Sheets Live Sync';
                headerBtn.classList.remove('hidden');
                document.getElementById('connectionScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            } else {
                dot.className = 'w-3 h-3 rounded-full bg-slate-500';
                sideName.innerText = 'Disconnected';
                sideStat.innerText = '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
            }
        }

        async function connectToSheet() {
            const url = document.getElementById('sheetUrlInput').value.trim();
            if (!url) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Google Script URL');

            try {
                const btn = document.getElementById('connectBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';

                const response = await fetch(url);
                if (!response.ok) throw new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');

                const data = await response.json();
                sheetUrl = url;
                await saveSheetUrl(url);

                if (typeof data === 'object' && data.products && data.boms) {
                    products = data.products;
                    boms = data.boms;
                    users = data.users || [];
                } else {
                    products = Array.isArray(data) ? data : [];
                    boms = [];
                    users = [];
                }

                renderProducts();
                renderBoms();
                renderUsers();
                updateUIStatus(true);
                updateSyncTime();
            } catch (e) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: ' + e.message + '\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Deploy Web App ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Anyone has access)');
            } finally {
                const btn = document.getElementById('connectBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-link"></i> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cloud';
            }
        }

        async function reconnectLastSheet() {
            const url = await getSavedUrl();
            if (url) {
                document.getElementById('sheetUrlInput').value = url;
                await connectToSheet();
            }
        }

        async function saveToSheet() {
            if (!sheetUrl) return;
            const sideStat = document.getElementById('saveStatus');

            try {
                sideStat.innerText = '‚òÅÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà Cloud...';

                const payload = {
                    action: 'saveAll',
                    sheets: [
                        {
                            name: 'Sheet 1',
                            header: ['id', 'category', 'code', 'name', 'api', 'sae', 'base', 'itemNum'],
                            data: products
                        },
                        {
                            name: 'Sheet 2',
                            header: ['id', 'created', 'bomNumber', 'itemNum', 'productName', 'packSize', 'quantity', 'unit', 'remark', 'parentId', 'status', 'createdBy', 'approvedBy'],
                            data: boms
                        },
                        {
                            name: 'Sheet 3',
                            header: ['id', 'name', 'password', 'role'],
                            data: users
                        }
                    ]
                };

                const response = await fetch(sheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                updateSyncTime();
                sideStat.innerText = '‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                setTimeout(() => { sideStat.innerText = 'Google Sheets Live Sync'; }, 3000);
            } catch (e) {
                console.error(e);
                sideStat.innerText = '‚ùå ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
            }
        }

        function updateSyncTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('th-TH', { hour12: false });
            const el = document.getElementById('lastSyncTime');
            if (el) el.innerText = timeStr;
        }

        function toggleSidebar(show) {
            document.body.classList.toggle('sidebar-open', show);
        }

        function switchView(view) {
            // Close sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                toggleSidebar(false);
            }

            const views = ['productDashboard', 'bomDashboard', 'userDashboard'];
            views.forEach(v => {
                const el = document.getElementById(v);
                if (el) el.classList.add('hidden');
            });

            // Reset Sub-menus
            document.getElementById('productActions').classList.add('hidden');
            document.getElementById('bomActions').classList.add('hidden');

            // Remove active classes from all nav items
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.className = "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-slate-400 hover:bg-slate-800 hover:text-white transition group mt-1";
            });

            if (view === 'products') {
                document.getElementById('productDashboard').classList.remove('hidden');
                document.getElementById('productActions').classList.remove('hidden');
                document.getElementById('navProducts').className = "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 bg-slate-800 text-white shadow-md";
                document.getElementById('mainTitle').innerText = 'Product List Dashboard';
                document.getElementById('mainTitleIcon').innerText = 'üìã';
            } else if (view === 'boms') {
                document.getElementById('bomDashboard').classList.remove('hidden');
                document.getElementById('bomActions').classList.remove('hidden');
                document.getElementById('navBoms').className = "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 bg-slate-800 text-white shadow-md";
                document.getElementById('mainTitle').innerText = 'BOM CODE Dashboard';
                document.getElementById('mainTitleIcon').innerText = 'üõ†Ô∏è';
                renderBoms();
            } else if (view === 'users') {
                document.getElementById('userDashboard').classList.remove('hidden');
                document.getElementById('navUsers').className = "nav-item w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 bg-slate-800 text-white shadow-md";
                document.getElementById('mainTitle').innerText = 'User Management';
                document.getElementById('mainTitleIcon').innerText = 'üë•';
                renderUsers();
            }
        }

        function setGroupBy(mode) {
            currentGroupBy = mode;
            collapsedGroups.clear(); // Reset collapse state when changing group mode
            // Update UI
            document.getElementById('groupBtn_category').className = `px-3 py-1 text-[10px] font-bold rounded-[6px] transition ${mode === 'category' ? 'bg-emerald-500 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`;
            document.getElementById('groupBtn_api').className = `px-3 py-1 text-[10px] font-bold rounded-[6px] transition ${mode === 'api' ? 'bg-emerald-500 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`;
            renderProducts();
        }

        function toggleGroup(groupName) {
            if (collapsedGroups.has(groupName)) {
                collapsedGroups.delete(groupName);
            } else {
                collapsedGroups.add(groupName);
            }
            renderProducts();
        }

        function toggleBomDetailModal(show, id = '') {
            const m = document.getElementById('bomDetailModal');
            m.classList.toggle('hidden', !show);
            if (show && id) {
                openBomDetail(id);
            }
        }

        function openBomDetail(id) {
            const b = boms.find(x => String(x.id) === String(id));
            if (!b) return;

            // If this is a free item, show parent detail instead (since they are a group now)
            if (b.parentId) {
                return openBomDetail(b.parentId);
            }

            const content = document.getElementById('bomDetailContent');
            const actions = document.getElementById('detailModalActions');
            const statusBadge = document.getElementById('detailStatusBadge');

            const isPending = (b.status || 'Pending') === 'Pending';
            const children = boms.filter(item => String(item.parentId) === String(b.id));

            // Status Badge
            statusBadge.innerHTML = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold uppercase ${isPending ? 'bg-amber-100 text-amber-600 border border-amber-200' : 'bg-emerald-100 text-emerald-600 border border-emerald-200'}">
                        <i class="fas ${isPending ? 'fa-clock' : 'fa-check-double'} mr-1"></i> ${b.status || 'Pending'}
                    </span>`;

            // Content details
            content.innerHTML = `
                        <!-- Left Side: Main Info & Metadata -->
                        <div class="space-y-4">
                            <!-- Main Product Info -->
                            <div class="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-2xl border border-slate-100 dark:border-slate-800">
                                <div class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest mb-3 flex items-center gap-2">
                                    <i class="fas fa-box text-xs"></i> BOM ‡∏´‡∏•‡∏±‡∏Å (Main Product)
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="col-span-2">
                                        <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</div>
                                        <div class="text-base font-bold text-slate-800 dark:text-white leading-tight">${b.productName}</div>
                                    </div>
                                    <div>
                                        <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">BOM Number</div>
                                        <div class="text-xs font-mono font-bold text-slate-600 dark:text-slate-400">${b.bomNumber}</div>
                                    </div>
                                    <div>
                                        <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">Item Number</div>
                                        <div class="text-xs font-mono font-bold text-emerald-600">${b.itemNum}</div>
                                    </div>
                                    <div class="col-span-2">
                                        <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°</div>
                                        <div class="text-sm font-bold text-slate-700 dark:text-slate-200">${b.packSize || '-'} / ${b.quantity || '-'} ${b.unit || 'L'}</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Metadata -->
                            <div class="bg-slate-50/50 dark:bg-slate-800/30 p-5 rounded-2xl border border-dashed border-slate-200 dark:border-slate-700">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-4">
                                    <div>
                                        <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥</div>
                                        <div class="text-xs font-bold text-slate-600 dark:text-slate-400">${cleanDate(b.created)}</div>
                                    </div>
                                    <div>
                                        <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</div>
                                        <div class="text-xs font-bold text-slate-600 dark:text-slate-400">${b.createdBy || '-'}</div>
                                    </div>
                                    <div>
                                        <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                                        <div class="text-xs font-bold text-slate-600 dark:text-slate-400">${b.approvedBy || '-'}</div>
                                    </div>
                                    <div>
                                        <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
                                        <div class="text-xs text-slate-500 italic">${b.remark || '-'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Side: Free Items -->
                        <div class="space-y-3">
                            ${children.length > 0 ? `
                                <div class="bg-amber-50/50 dark:bg-amber-900/10 p-5 rounded-2xl border border-amber-100 dark:border-amber-900/30 h-full">
                                    <div class="text-[10px] font-bold text-amber-600 uppercase tracking-widest mb-4 flex items-center gap-2">
                                        <i class="fas fa-gift text-xs"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏° (${children.length})
                                    </div>
                                    <div class="space-y-3">
                                        ${children.map((c, i) => `
                                            <div class="flex justify-between items-start pt-3 ${i > 0 ? 'border-t border-amber-200/40' : ''}">
                                                <div class="flex-1 pr-4">
                                                    <div class="text-[9px] text-amber-600/60 font-bold uppercase mb-0.5">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</div>
                                                    <div class="text-sm font-bold text-slate-800 dark:text-white leading-tight mb-2">${c.productName}</div>
                                                    <div class="text-[9px] text-amber-600/60 font-bold uppercase mb-0.5">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                                                    <div class="text-[10px] font-mono font-bold text-amber-600">${c.itemNum}</div>
                                                </div>
                                                <div class="flex flex-col items-end">
                                                    <div class="text-right">
                                                        <div class="text-[9px] text-slate-400 font-bold uppercase mb-0.5">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
                                                        <div class="text-base font-black text-slate-800 dark:text-amber-500">${c.packSize || '-'} / ${c.quantity || '-'}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div class="flex flex-col items-center justify-center h-full min-h-[150px] border-2 border-dashed border-slate-100 dark:border-slate-800 rounded-3xl opacity-40">
                                    <i class="fas fa-gift text-3xl text-slate-300 mb-2"></i>
                                    <div class="text-xs font-medium text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°</div>
                                </div>
                            `}
                        </div>
                    `;

            // Actions
            actions.innerHTML = '';
            // Using a wrapper to ensure consistent sizing
            let buttonsHTML = '';

            if (isPending) {
                buttonsHTML += `
                    <button onclick="approveBom('${b.id}'); toggleBomDetailModal(false);" class="flex-1 py-3 bg-blue-600 text-white text-[11px] font-bold rounded-xl shadow-lg shadow-blue-500/10 hover:bg-blue-700 hover:shadow-blue-500/20 active:scale-95 transition flex items-center justify-center gap-2">
                        <i class="fas fa-check-double text-[10px]"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° (Approve Group)
                    </button>
                `;
            }

            buttonsHTML += `
                <button onclick="openEditBomModal('${b.id}', true); toggleBomDetailModal(false);" class="flex-[2] py-3 border border-emerald-200 text-emerald-500 hover:bg-emerald-50 hover:border-emerald-400 rounded-xl transition flex items-center justify-center gap-2 text-[11px] font-bold active:scale-95">
                    <i class="fas fa-edit text-[10px]"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Edit Group)
                </button>
            `;

            buttonsHTML += `
                <button onclick="deleteBom('${b.id}'); toggleBomDetailModal(false);" class="flex-1 py-3 border border-red-200 text-red-500 hover:bg-red-50 hover:border-red-400 rounded-xl transition flex items-center justify-center gap-2 text-[11px] font-bold active:scale-95">
                    <i class="fas fa-trash-alt text-[10px]"></i> ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
                </button>
            `;

            actions.innerHTML = buttonsHTML;
        }

        function renderBoms() {
            const body = document.getElementById('bomBody');
            const countEl = document.getElementById('bomCount');
            const term = document.getElementById('bomSearchInput').value.trim().toLowerCase();
            body.innerHTML = '';

            const filtered = boms.filter(b =>
                String(b.bomNumber || '').toLowerCase().includes(term) ||
                String(b.productName || '').toLowerCase().includes(term) ||
                String(b.itemNum || '').toLowerCase().includes(term)
            );

            // Update Statistics
            const allMains = boms.filter(b => !b.parentId);
            const total = allMains.length;
            const active = allMains.filter(b => b.status === 'Active').length;
            const pending = total - active;

            const statTotal = document.getElementById('statTotalBoms');
            const statActive = document.getElementById('statActiveBoms');
            const statPending = document.getElementById('statPendingBoms');

            if (statTotal) statTotal.innerText = total;
            if (statActive) statActive.innerText = active;
            if (statPending) statPending.innerText = pending;

            countEl.innerText = `${filtered.length} Items Total`;

            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="px-6 py-20 text-center text-slate-400 italic font-medium bg-slate-50/20">
                    <i class="fas fa-search block text-4xl mb-4 opacity-20"></i>
                    ${term ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BOM ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BOM ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ'}
                </td></tr>`;
                return;
            }

            // Identify main items to display
            // 1. All main items that match the term
            // 2. All main items that have children matching the term
            const matchedParentIds = new Set();
            filtered.forEach(b => {
                if (b.parentId) matchedParentIds.add(String(b.parentId));
                else matchedParentIds.add(String(b.id));
            });

            const mainsToRender = boms.filter(b => !b.parentId && matchedParentIds.has(String(b.id)));

            countEl.innerText = `${mainsToRender.length} BOM Groups`;

            mainsToRender.sort((a, b) => new Date(b.created) - new Date(a.created)).forEach(b => {
                renderBomRow(b);
            });
        }

        function renderBomRow(b) {
            const body = document.getElementById('bomBody');
            const hasGifts = boms.some(item => String(item.parentId) === String(b.id));
            const r = document.createElement('tr');
            r.setAttribute('data-id', b.id);
            r.className = "hover:bg-emerald-50/30 dark:hover:bg-emerald-900/10 transition-colors";

            const status = b.status || 'Pending';
            const isPending = status === 'Pending';

            r.innerHTML = `
                <td class="px-3 py-4 text-slate-500 text-[10px] whitespace-nowrap">
                    ${cleanDate(b.created) || '-'}
                </td>
                <td class="px-3 py-4 whitespace-nowrap">
                    <button onclick="toggleBomDetailModal(true, '${b.id}')" 
                        class="text-left font-bold border-b border-transparent hover:border-blue-500 hover:text-blue-500 transition-all font-mono text-xs text-slate-700 dark:text-slate-300">
                        ${b.bomNumber || '-'}
                    </button>
                </td>
                <td class="px-3 py-4 font-mono text-[10px] font-bold text-emerald-600 whitespace-nowrap">${b.itemNum || '-'}</td>
                <td class="px-3 py-4 font-medium flex items-center gap-2 max-w-[150px] lg:max-w-[250px]">
                    <span class="truncate" title="${b.productName || ''}">${b.productName || '-'}</span>
                    ${hasGifts ? `
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-lg bg-amber-50 text-amber-600 border border-amber-200 text-xs font-black shrink-0 shadow-sm shadow-amber-500/10">
                            <i class="fas fa-gift"></i>
                        </span>
                    ` : ''}
                </td>
                <td class="px-3 py-4 text-slate-500 text-[10px] whitespace-nowrap">${b.createdBy || '-'}</td>
                <td class="px-3 py-4 text-slate-500 text-[10px] whitespace-nowrap">${b.approvedBy || '-'}</td>
                <td class="px-3 py-4 text-center whitespace-nowrap">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-bold uppercase ${isPending ? 'bg-amber-100 text-amber-600 border border-amber-200' : 'bg-emerald-100 text-emerald-600 border border-emerald-200'}">
                        <i class="fas ${isPending ? 'fa-clock' : 'fa-check-double'} mr-1"></i> ${status}
                    </span>
                </td>
            `;
            body.appendChild(r);
        }

        function approveBom(id) {
            toggleApprovalModal(true, id);
        }

        async function saveBom() {
            const fields = ['created', 'bomNumber', 'itemNum', 'productName', 'packSize', 'quantity', 'unit', 'remark', 'parentId', 'createdBy'];
            const editId = document.getElementById('editBomId').value;
            const data = {};
            const mapping = {
                created: 'bomCreated',
                bomNumber: 'bomNumber',
                itemNum: 'bomItemNum',
                productName: 'bomProductName',
                packSize: 'bomPackSize',
                quantity: 'bomQuantity',
                unit: 'bomUnit',
                remark: 'bomRemark',
                parentId: 'bomParentId',
                createdBy: 'bomCreatedBy'
            };
            fields.forEach(f => {
                const el = document.getElementById(mapping[f]);
                if (el) data[f] = el.value.trim();
            });

            if (!data.bomNumber || !data.itemNum) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ BOM Number ‡πÅ‡∏•‡∏∞ Item Number');

            let mainId = editId;
            if (editId) {
                const idx = boms.findIndex(b => String(b.id) === String(editId));
                // Force status back to Pending upon edit
                if (idx !== -1) boms[idx] = { ...boms[idx], ...data, status: 'Pending', approvedBy: '' };

                boms = boms.filter(b => String(b.parentId) !== String(mainId));
            } else {
                mainId = Date.now().toString();
                boms.push({ ...data, id: mainId, status: 'Pending', approvedBy: '' });
            }

            // Save temporary gifts added/loaded in modal
            if (tempFreeGifts.length > 0) {
                tempFreeGifts.forEach((g, i) => {
                    boms.push({
                        id: (Date.now() + 1000 + i).toString(),
                        created: data.created,
                        bomNumber: data.bomNumber,
                        itemNum: g.itemNum,
                        productName: g.productName,
                        packSize: g.packSize,
                        quantity: g.quantity,
                        unit: '',
                        remark: g.remark || '',
                        parentId: mainId,
                        status: 'Pending',
                        createdBy: data.createdBy
                    });
                });
            }

            renderBoms();

            // Save current mainId for return navigation
            const savedMainId = mainId;
            const returnBack = shouldReturnToDetail;

            toggleBomModal(false); // This will reset shouldReturnToDetail

            if (returnBack && savedMainId) {
                toggleBomDetailModal(true, savedMainId);
            }

            if (sheetUrl) await saveToSheet();
        }

        function openEditBomModal(id, fromDetail = false) {
            shouldReturnToDetail = fromDetail;
            // Find the BOM. If it's a child, find its parent instead for unified editing.
            let b = boms.find(bom => String(bom.id) === String(id));
            if (!b) return;

            if (b.parentId) {
                const parent = boms.find(p => String(p.id) === String(b.parentId));
                if (parent) b = parent;
            }

            document.getElementById('editBomId').value = b.id;
            document.getElementById('bomParentId').value = b.parentId || '';

            toggleBomModal(true);
            document.getElementById('bomModalTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç BOM CODE';
            document.getElementById('bomModalIcon').className = 'fas fa-edit';

            document.getElementById('bomCreated').value = cleanDate(b.created);
            document.getElementById('bomNumber').value = b.bomNumber || '';
            document.getElementById('bomItemNum').value = b.itemNum || '';
            document.getElementById('bomProductName').value = b.productName || '';
            document.getElementById('bomPackSize').value = b.packSize || '';
            document.getElementById('bomQuantity').value = b.quantity || '';
            document.getElementById('bomUnit').value = b.unit || 'L';
            document.getElementById('bomRemark').value = b.remark || '';
            document.getElementById('bomCreatedBy').value = b.createdBy || '';

            // Unified Editing: Load children into tempFreeGifts
            const children = boms.filter(c => String(c.parentId) === String(b.id));
            tempFreeGifts = children.map(c => ({
                id: c.id,
                itemNum: c.itemNum,
                productName: c.productName,
                packSize: c.packSize,
                quantity: c.quantity,
                remark: c.remark || ''
            }));
            renderTempGifts();

            document.getElementById('bomNumber').disabled = false;
            document.getElementById('bomModalSubtitle').innerText = 'Unified Group Editor';
            document.getElementById('modalGiftSection').classList.toggle('hidden', false);
        }

        function deleteBom(id) {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ BOM ‡∏ô‡∏µ‡πâ?')) {
                // Also delete children? User usually expects this.
                const hasChildren = boms.some(b => String(b.parentId) === String(id));
                if (hasChildren && !confirm('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ "‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°" ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢ ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

                boms = boms.filter(b => String(b.id) !== String(id) && String(b.parentId) !== String(id));
                renderBoms();
                if (sheetUrl) saveToSheet();
            }
        }

        function renderProducts() {
            const body = document.getElementById('productBody');
            const countEl = document.getElementById('productCount');
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            body.innerHTML = '';

            const filtered = products.filter(p => String(p.code || '').toLowerCase().includes(term) || String(p.name || '').toLowerCase().includes(term));
            // Calculate Item Number I count from filtered data
            const countI = filtered.filter(p => String(p.itemNum || '').trim().toUpperCase().startsWith('I')).length;

            document.getElementById('productStats').innerText = `${filtered.length} Items`;
            if (document.getElementById('productStatsTop')) {
                document.getElementById('productStatsTop').innerText = `${filtered.length} Items`;
            }
            document.getElementById('itemICount').innerHTML = `<i class="fas fa-info-circle"></i> Item I: ${countI}`;

            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="px-6 py-20 text-center text-slate-400 italic font-medium bg-slate-50/20">
                    <i class="fas fa-search block text-4xl mb-4 opacity-20"></i>
                    ${term ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ'}
                </td></tr>`;
                return;
            }

            const groupedSize = filtered.reduce((acc, obj) => {
                const key = obj[currentGroupBy] || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                if (!acc[key]) acc[key] = [];
                acc[key].push(obj);
                return acc;
            }, {});

            Object.keys(groupedSize).sort().forEach(cat => {
                const isCollapsed = collapsedGroups.has(cat);
                const hRow = document.createElement('tr');
                hRow.className = "bg-slate-50/80 dark:bg-slate-800/40 text-slate-800 dark:text-emerald-400 font-bold text-xs uppercase cursor-pointer hover:bg-slate-100 transition-colors group/header";
                hRow.onclick = () => toggleGroup(cat);

                const icon = currentGroupBy === 'api' ? 'fas fa-certificate' : 'fas fa-tag';
                const arrow = isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down';

                hRow.innerHTML = `
                    <td colspan="7" class="px-6 py-3 border-l-4 border-emerald-500">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="${icon} mr-2 text-emerald-500 opacity-60"></i> ${cat}
                                <span class="ml-2 text-[10px] text-slate-400 font-normal">(${groupedSize[cat].length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                            </div>
                            <i class="fas ${arrow} text-[10px] text-slate-300 group-hover/header:text-emerald-500 transition-transform"></i>
                        </div>
                    </td>`;
                body.appendChild(hRow);

                if (!isCollapsed) {
                    groupedSize[cat].forEach(p => {
                        const r = document.createElement('tr');
                        r.className = "hover:bg-emerald-50/30 dark:hover:bg-emerald-900/10 transition-colors";
                        r.innerHTML = `
                <td class="px-3 py-4 font-bold text-slate-700 dark:text-slate-300 font-mono text-xs whitespace-nowrap">${p.code || '-'}</td>
                            <td class="px-3 py-4 font-medium max-w-[200px] lg:max-w-[350px]"><div class="truncate" title="${p.name || ''}">${p.name || '-'}</div></td>
                            <td class="px-3 py-4 text-slate-500 text-xs whitespace-nowrap">${p.api || '-'}</td>
                            <td class="px-3 py-4 text-slate-500 text-xs whitespace-nowrap">${p.sae || '-'}</td>
                            <td class="px-3 py-4 text-slate-500 text-xs whitespace-nowrap">${p.base || '-'}</td>
                            <td class="px-3 py-4 text-slate-400 font-mono text-[10px] whitespace-nowrap">${p.itemNum || '-'}</td>
                            <td class="px-3 py-4 text-center whitespace-nowrap">
                                <div class="flex items-center justify-center gap-1">
                                    <button onclick="openEditModal('${p.id}')" class="w-7 h-7 rounded-lg border border-emerald-200 text-emerald-500 hover:bg-emerald-500 hover:text-white hover:border-emerald-500 transition">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button onclick="deleteProduct('${p.id}')" class="w-7 h-7 rounded-lg border border-red-200 text-red-400 hover:bg-red-500 hover:text-white hover:border-red-500 transition">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </td>
            `;
                        body.appendChild(r);
                    });
                }
            });
        }

        function checkDuplicateCode() {
            const code = document.getElementById('code').value.trim();
            const editId = document.getElementById('editProductId').value;
            const err = document.getElementById('codeError');

            // If editing, allow the code if it belongs to the item being edited
            const isDup = code && products.some(p => String(p.code || '').toLowerCase() === String(code).toLowerCase() && String(p.id) !== String(editId));

            err.classList.toggle('hidden', !isDup);
            return isDup;
        }

        async function saveProduct() {
            const fields = ['category', 'code', 'name', 'api', 'sae', 'base', 'itemNum'];
            const editId = document.getElementById('editProductId').value;
            const data = {};
            fields.forEach(id => data[id] = document.getElementById(id).value.trim());

            if (!data.code || !data.name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå');

            // Strict Duplicate Check
            if (checkDuplicateCode()) {
                alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∑‡πà‡∏ô');
                document.getElementById('code').focus();
                return;
            }

            if (editId) {
                // Update existing
                const idx = products.findIndex(p => String(p.id) === String(editId));
                if (idx !== -1) {
                    products[idx] = { ...products[idx], ...data };
                }
            } else {
                // Add new
                products.push({ ...data, id: Date.now().toString() });
            }

            renderProducts();
            toggleModal(false);
            if (sheetUrl) saveToSheet();
        }

        // --- Excel Comparison Logic (Robust Version) ---
        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('excelFileName').innerText = file.name;
            const reader = new FileReader();

            reader.onload = async (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    let allRows = [];
                    workbook.SheetNames.forEach(name => {
                        const sheet = workbook.Sheets[name];
                        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                        if (rows.length > 0) allRows = allRows.concat(rows);
                    });

                    processExcelRows(allRows);
                } catch (err) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢');
                    console.error(err);
                } finally {
                    e.target.value = ''; // Reset input to allow same file re-upload
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function resetExcelChecker() {
            document.getElementById('excelResultArea').classList.add('hidden');
            document.getElementById('excelDropZone').classList.remove('hidden');
            document.getElementById('excelResultBody').innerHTML = '';
            document.getElementById('excelDupBody').innerHTML = '';
            document.getElementById('newItemsAlert').classList.add('hidden');
            switchExcelTab('new');
        }

        function switchExcelTab(tab) {
            const isNew = tab === 'new';
            document.getElementById('excelNewTabContent').classList.toggle('hidden', !isNew);
            document.getElementById('excelDupTabContent').classList.toggle('hidden', isNew);

            // Update buttons
            const newBtn = document.getElementById('excelTabBtn_new');
            const dupBtn = document.getElementById('excelTabBtn_dup');

            if (isNew) {
                newBtn.className = "flex-1 sm:flex-none px-4 py-2 text-[10px] font-bold rounded-lg transition-all duration-200 bg-white dark:bg-slate-700 text-emerald-600 shadow-sm flex items-center justify-center gap-2";
                dupBtn.className = "flex-1 sm:flex-none px-4 py-2 text-[10px] font-bold rounded-lg transition-all duration-200 text-slate-400 hover:text-slate-600 flex items-center justify-center gap-2 border-transparent";
            } else {
                newBtn.className = "flex-1 sm:flex-none px-4 py-2 text-[10px] font-bold rounded-lg transition-all duration-200 text-slate-400 hover:text-slate-600 flex items-center justify-center gap-2 border-transparent";
                dupBtn.className = "flex-1 sm:flex-none px-4 py-2 text-[10px] font-bold rounded-lg transition-all duration-200 bg-white dark:bg-slate-700 text-emerald-600 shadow-sm flex items-center justify-center gap-2";
            }
        }

        function processExcelRows(rows) {
            const newBody = document.getElementById('excelResultBody');
            const dupBody = document.getElementById('excelDupBody');
            const alertEl = document.getElementById('newItemsAlert');

            newBody.innerHTML = '';
            dupBody.innerHTML = '';
            pendingExcelItems = [];

            let uniqueNewCodes = new Set();
            let uniqueDupCodes = new Set();

            const headerKeywords = {
                code: ['CODE', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏£‡∏´‡∏±‡∏™'],
                name: ['NAME', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'],
                category: ['CATEGORY', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏Å‡∏•‡∏∏‡πà‡∏°'],
                api: ['API'],
                sae: ['SAE', 'ISO', 'SAE/ISO'],
                base: ['BASE', 'BASE OIL', '‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'],
                itemNum: ['ITEM NUMBER', 'ITEM NO', 'ITEMNUM', '‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏≠‡πÄ‡∏ó‡∏°']
            };

            let headerIdx = -1;
            let cols = { code: -1, name: -1, category: -1, api: -1, sae: -1, base: -1, itemNum: -1 };

            for (let i = 0; i < Math.min(rows.length, 50); i++) {
                const row = rows[i];
                if (!Array.isArray(row)) continue;

                const cIdx = row.findIndex(cell => cell && headerKeywords.code.some(k => String(cell).toUpperCase().includes(k)));
                if (cIdx !== -1) {
                    headerIdx = i;
                    break;
                }
            }

            if (headerIdx !== -1) {
                const hRow = rows[headerIdx];
                Object.keys(headerKeywords).forEach(key => {
                    cols[key] = hRow.findIndex(cell => cell && headerKeywords[key].some(k => String(cell).toUpperCase().includes(k)));
                });
            } else {
                headerIdx = rows.findIndex(r => Array.isArray(r) && r.filter(c => String(c).trim() !== '').length >= 2);
                if (headerIdx !== -1) {
                    cols.code = 0;
                    cols.name = 1;
                }
            }

            if (headerIdx === -1 || cols.code === -1) {
                newBody.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (CODE) ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ</td></tr>';
                return;
            }

            const processedCodes = new Set();

            for (let i = headerIdx + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!Array.isArray(row) || row.length === 0) continue;

                const rawData = {
                    code: String(row[cols.code] || '').trim(),
                    name: cols.name !== -1 ? String(row[cols.name] || '').trim() : '',
                    category: cols.category !== -1 ? String(row[cols.category] || '').trim() : '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel',
                    api: cols.api !== -1 ? String(row[cols.api] || '').trim() : '-',
                    sae: cols.sae !== -1 ? String(row[cols.sae] || '').trim() : '-',
                    base: cols.base !== -1 ? String(row[cols.base] || '').trim() : '-',
                    itemNum: cols.itemNum !== -1 ? String(row[cols.itemNum] || '').trim() : '-'
                };

                // Skip if code is empty or is a header repeat
                if (!rawData.code || headerKeywords.code.some(k => rawData.code.toUpperCase() === k)) continue;

                // Extremely simple guard for truly empty data rows
                if (!rawData.code && !rawData.name) continue;

                const isDup = products.some(p => String(p.code || '').trim().toLowerCase() === String(rawData.code).toLowerCase());
                const lowerCode = rawData.code.toLowerCase();

                if (isDup) {
                    uniqueDupCodes.add(lowerCode);
                    // Only render once per unique code to keep UI clean
                    if (!processedCodes.has(lowerCode)) {
                        const tr = document.createElement('tr');
                        tr.className = "opacity-60 bg-slate-50/50";
                        tr.innerHTML = `
                <td class="px-4 py-3 font-bold font-mono text-slate-400">${rawData.code}</td>
                            <td class="px-4 py-3 text-slate-400 italic text-xs">
                                <div>${rawData.name || '-'}</div>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <i class="fas fa-check-circle text-slate-300"></i>
                            </td>
            `;
                        dupBody.appendChild(tr);
                    }
                } else {
                    uniqueNewCodes.add(lowerCode);
                    if (!processedCodes.has(lowerCode)) {
                        pendingExcelItems.push(rawData);
                        const tr = document.createElement('tr');
                        tr.className = "bg-emerald-50/30";
                        tr.innerHTML = `
                <td class="px-4 py-3">
                                <input type="checkbox" name="excelSelect" value="${pendingExcelItems.length - 1}" checked onchange="updateBulkAddBtn()"
                                    class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500 transition">
                            </td>
                            <td class="px-4 py-3 font-bold font-mono text-slate-700">${rawData.code}</td>
                            <td class="px-4 py-3 text-slate-500 italic text-xs">
                                <div>${rawData.name || '-'}</div>
                                <div class="text-[9px] text-slate-400 mt-1">${rawData.api} | ${rawData.sae} | ${rawData.base}</div>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="fillFormFromExcel('${rawData.code}', '${rawData.name.replace(/'/g, "\\'")}', '${rawData.category}', '${rawData.api}', '${rawData.sae}', '${rawData.base}', '${rawData.itemNum}')" class="px-3 py-1 bg-emerald-600 text-white rounded-lg text-[10px] font-bold hover:bg-emerald-700 transition">
                                    <i class="fas fa-edit"></i> ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°
                                </button>
                            </td>
                `;
                        newBody.appendChild(tr);
                    }
                }
                processedCodes.add(lowerCode);
            }

            const newCount = uniqueNewCodes.size;
            const dupCount = uniqueDupCodes.size;

            if (newCount === 0) {
                newBody.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-slate-400">üéâ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß)</td></tr>';
            }
            if (dupCount === 0) {
                dupBody.innerHTML = '<tr><td colspan="3" class="px-6 py-10 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
            }

            document.getElementById('countNew').innerText = newCount;
            document.getElementById('countDup').innerText = dupCount;
            alertEl.classList.toggle('hidden', newCount === 0);

            document.getElementById('excelDropZone').classList.add('hidden');
            document.getElementById('excelResultArea').classList.remove('hidden');

            // Auto switch to Tab with results
            if (newCount === 0 && dupCount > 0) switchExcelTab('dup');
            else switchExcelTab('new');
        }

        async function bulkAddFromExcel() {
            const selectedIdx = Array.from(document.querySelectorAll('input[name="excelSelect"]:checked')).map(cb => parseInt(cb.value));

            if (selectedIdx.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°');
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${selectedIdx.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ? `)) return;

            const now = Date.now();
            selectedIdx.forEach((idx, i) => {
                const item = pendingExcelItems[idx];
                products.push({
                    id: (now + i).toString(),
                    code: item.code,
                    name: item.name,
                    category: item.category,
                    api: item.api,
                    sae: item.sae,
                    base: item.base,
                    itemNum: item.itemNum
                });
            });

            pendingExcelItems = [];
            renderProducts();
            toggleExcelModal(false);
            if (sheetUrl) await saveToSheet();
            alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }

        function toggleSelectAllExcel(checked) {
            const cbs = document.querySelectorAll('input[name="excelSelect"]');
            cbs.forEach(cb => cb.checked = checked);
            updateBulkAddBtn();
        }

        function updateBulkAddBtn() {
            const count = document.querySelectorAll('input[name="excelSelect"]:checked').length;
            const btn = document.getElementById('bulkAddBtn');
            const selectAllCb = document.getElementById('selectAllExcel');
            const allCount = document.querySelectorAll('input[name="excelSelect"]').length;

            if (btn) {
                btn.innerHTML = `<i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å(${count})`;
                btn.disabled = count === 0;
                btn.style.opacity = count === 0 ? '0.5' : '1';
            }

            if (selectAllCb) {
                selectAllCb.checked = count === allCount && allCount > 0;
            }
        }

        function fillFormFromExcel(code, name, category, api, sae, base, itemNum) {
            toggleExcelModal(false);
            toggleModal(true);
            document.getElementById('code').value = code || '';
            document.getElementById('name').value = name || '';
            document.getElementById('category').value = category || '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel';
            document.getElementById('api').value = api || '-';
            document.getElementById('sae').value = sae || '-';
            document.getElementById('base').value = base || '-';
            document.getElementById('itemNum').value = itemNum || '-';
            checkDuplicateCode();
        }

        async function deleteAllProducts() {
            if (products.length === 0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏•‡∏ö');
            if (confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö!')) {
                if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Action ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)?')) {
                    products = [];
                    renderProducts();
                    if (sheetUrl) await saveToSheet();
                    alert('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
            }
        }

        function deleteProduct(id) {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) {
                products = products.filter(p => String(p.id) !== String(id));
                renderProducts();
                if (sheetUrl) saveToSheet();
            }
        }

        // --- Init ---
        window.addEventListener('load', async () => {
            const url = await getSavedUrl();
            if (url) {
                document.getElementById('reconnectArea').classList.remove('hidden');
                document.getElementById('sidebarReconnect').classList.remove('hidden');
                document.getElementById('lastFileHint').innerText = `‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${url.substring(0, 30)}...`;
            }
        });
    </script>
</body>

</html>